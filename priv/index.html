<html>
<head>
 <link href='/static/css/slate/bootstrap.css' rel='stylesheet'>
  <link href='/static/css/custom.css' rel='stylesheet'>
  <script type="text/javascript" src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
  <script type="text/javascript" src='/static/js/handlebars.js'></script>
  <script type="text/javascript" src='/static/js/bootstrap.js'></script>
  <script type="text/javascript" src='/static/js/ws_events_dispatcher.js'></script>
</head>
<body>

  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">erl-shib</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      <div>
	<div class="row">
          <form>
            <div class="history_container">
              <div id="history_list">
              </div>            
            </div>
            <div>
              <textarea class="input-xxlarge new_query" id="hql" rows="10"></textarea>
            </div>
            <div class="well editbox">
              <div>
		<a class="btn" id="new_query" href="#">new query</a>
		<a class="btn" id="copy_to_new_query" href="#">copy_to_new_query</a>
		<a class="btn" id="execute" href="#">execute</a>
              </div>
              <div id="result_panel">
		<div>
                  <a class="btn" href="#">delete</a>
                  <a class="btn" href="#">show full</a>
                  <a class="btn" href="#">show head</a>
                  <a class="btn" id="tsv" href="#">tsv</a>
                  <a class="btn" id="csv" href="#">csv</a>
		</div>
		<div id="result_information">
		</div>
              </div>
            </div>
          </form>
	</div>
      </div>
    </header>
  </div>
  <script type="text/x-handlebars-template" id="histories_template">
    <ul class="nav nav-list">
      <li class="nav-header">history</li>
      {{#each histories}}
      <li><a href="javascript:selected_history('{{this.query_id}}')">
          <div id="query-history-{{this.query_id}}" class="query_item">
            <div class="query_time">
              {{this.start_at}}
            </div>
            <div class="query_statement">
              {{this.hql}}
            </div>
            <div class="query_information">
              <span class="status">{{this.status}}</span>
              <span class="etc">{{this.end_at}}</span>
            </div>
        </div></a>
      </li>
      <li class="divider"></li>
      {{/each}}
    </ul>
  </script>
  <script type="text/x-handlebars-template" id="result_information_template">
    <div>
      <span>Query Status:</span><span>{{history.status}}</span>
    </div>
    <div>
      <span>Start at: </span><span>{{history.start_at}}</span>
    </div>
    <div>
      <span>End at: </span><span>{{history.end_at}}</span>
    </div>
  </script>
  <script type="text/javascript">
    update_histories = function(callback) {
      var source = $("#histories_template").html();
      var template = Handlebars.compile(source);
      $.ajax({
        type: 'GET',
        url: '/histories',
        dataType: 'json',
        success: function (data) {
          var content = {
            histories: data
          };
          history_map = {};
          for(var i = 0; i < data.length; i++) {
            var history = data[i];
            history_map[history["query_id"]] = history;
          }
          $("#history_list").html(template(content));
          if(callback) {
            callback();
          }
        },
      });
    }
  </script>
  <script type="text/javascript">
    var qid = null;
    var server = new FancyWebSocket('ws://$host$:$port$/websocket');
    server.bind('open', function() {
       // alert("FancyWebSocket#open");
    });
    server.bind('query_success', function(query) {
        alert(query.id + " has done");
        update_histories(function() {
          set_query_result(query.id);
        });
    });
    $("#execute").click(function() {
      //alert($("#hql").val());
      server.send('query_start', $('#hql').val());
      setTimeout(function() {
        update_histories();
      }, 2000);
      return false;
    });
    $("#csv").click(function() {
      location.href="/download/csv/" + qid;
      return false;
    });
    $("#tsv").click(function() {
      location.href="/download/tsv/" + qid;
      return false;
    });
    $("#new_query").click(function() {
      new_query();
      return false;
    });    
    $("#copy_to_new_query").click(function() {
      var hql = $("#hql").val();
      new_query();
      $("#hql").val(hql);
      return false;
    });    
    selected_history = function(query_id) {
      set_query_result(query_id);
    }
    set_query_result = function(query_id) {
      var history = history_map[query_id];
      if(!history) {
        return;
      }
      qid = query_id;
      var hql = history.hql
      // set visible to result_panel
      var source = $("#result_information_template").html();
      var template = Handlebars.compile(source);
      var content = {
        history: history_map[query_id]
      };
      $("#result_information").html(template(content));
      
      $("#result_panel").show();
      $("#copy_to_new_query").show();
      $("#execute").hide();
      $("#hql").val(hql);
      $("#hql").attr("readonly", "");
      $("#hql").removeClass("new_query");
      $("#hql").addClass("result");
    }
    new_query = function() {
      qid = null;
      $("#result_panel").hide();
      $("#copy_to_new_query").hide();
      $("#execute").show();
      $("#hql").removeAttr("readonly");
      $("#hql").removeClass("result");      
      $("#hql").addClass("new_query");      
      $("#hql").val("");
    }
  </script>
  <script type="text/javascript">
    $(document).ready(function() {
      $("#copy_to_new_query").hide();
      update_histories();
    });
  </script>
</body>
</html>
