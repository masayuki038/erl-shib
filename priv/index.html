<html>
<head>
 <link href='/static/css/slate/bootstrap.css' rel='stylesheet'>
  <link href='/static/css/custom.css' rel='stylesheet'>
  <script type="text/javascript" src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
  <script type="text/javascript" src='/static/js/handlebars.js'></script>
  <script type="text/javascript" src='/static/js/bootstrap.js'></script>
  <script type="text/javascript" src='/static/js/ws_events_dispatcher.js'></script>
</head>
<body>

  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="#">erl-shib</a>
        <div class="nav-collapse collapse">
          <ul class="nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      <div>
	<div class="row">
          <form>
            <div>
              <textarea class="input-xxlarge" id="hql" rows="10"></textarea>
            </div>
            <div>
              <a class="btn" href="#">new query</a>
              <a class="btn" id="execute" href="#">execute</a>
            </div>
            <div id="result_panel">
              <a class="btn" href="#">delete</a>
              <a class="btn" href="#">show full</a>
              <a class="btn" href="#">show head</a>
              <a class="btn" id="tsv" href="#">tsv</a>
              <a class="btn" id="csv" href="#">csv</a>
            </div>
          </form>
	</div>
      </div>
      <div style="float: right;" id="histories">
      </div>
      <script type="text/x-handlebars-template" id="histories_template">
        <ul class="history_list">
          {{#each histories}}
          <li>{{this.query_id}}</li>
          {{/each}}
        </ul>
      </script>
      <script type="text/javascript">
        var source = $("#histories_template").html();
        var template = Handlebars.compile(source);
        $.ajax({
          type: 'GET',
          url: '/histories',
          dataType: 'json',
          success: function (data) {
            var content = {
              histories: data
            };
            $("#histories").html(template(content));
          },
        });
      </script>
    </header>
  </div>
  <script type="text/javascript">
    var qid = null;
    var server = new FancyWebSocket('ws://$host$:$port$/websocket');
    server.bind('open', function() {
       // alert("FancyWebSocket#open");
    });
    server.bind('query_success', function(query) {
        alert(query.id + " has done");
        qid = query.id;
        // set visible to result_panel
        $("#result_panel").show();
    });
    $("#execute").click(function() {
      //alert($("#hql").val());
      server.send('query_start', $('#hql').val());
      return false;
    });
    $("#csv").click(function() {
      location.href="/download/csv/" + qid;
    });
    $("#tsv").click(function() {
      location.href="/download/tsv/" + qid;
    });
  </script>
</body>
</html>
